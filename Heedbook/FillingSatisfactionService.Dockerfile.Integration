FROM microsoft/dotnet:2.2-sdk AS test-env
WORKDIR /app
COPY . .

RUN mkdir /opt; exit 0;
RUN chmod -R 777 /opt/; exit 0;
RUN mkdir /opt/download; exit 0;
RUN chmod -R 777 /opt/download; exit 0;

RUN ./rabbit_test_setup.sh; exit 0;
RUN ./test_environment_setup.sh; exit 0;

WORKDIR /app/HBOperations
RUN killall -9 dotnet; exit 0;   

WORKDIR /app/HBOperations/FillingSatisfactionServiceTests/

RUN dotnet restore .; exit 0;

#RUN ../../rabbit_test_start.sh; exit 0;
RUN rm TestResults/*.trx; exit 0;
RUN dotnet test --logger:"trx;LogFileName=results.trx" ; base64 /app/HBOperations/FillingSatisfactionServiceTests/TestResults/results*.trx > /app/HBOperations/FillingSatisfactionServiceTests/TestResults/results_base64 ;
if grep -c 'outcome="Failed"' /app/HBOperations/FillingSatisfactionServiceTests/TestResults/results*.trx
then
	echo "exit"
	exit 125;
else
	echo "Test Pass"
fi
curl -X POST "https://heedbookapi.northeurope.cloudapp.azure.com/user/ExpressTester/PublishUnitTestResults" -H  "accept: application/json" -H  "Content-Type: application/json-patch+json" -d "{ \"TrxTextBase64\" : \"$(cat /app/HBOperations/FillingSatisfactionServiceTests/TestResults/results_base64)\" }";
